<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Porte-√†-Porte</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">

  <!-- Barre de navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üìã Porte-√†-Porte</a>
      <div class="d-flex">
        <span id="userEmail" class="text-white me-3"></span>
        <button id="logoutBtn" class="btn btn-danger btn-sm">Se d√©connecter</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Upload CSV (r√©serv√© admin ou 1ere fois) -->
    <div id="uploadSection" class="mb-3">
      <label for="csvFile" class="form-label">Importer le fichier √©lecteurs (CSV)</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <button id="uploadBtn" class="btn btn-primary mt-2">Charger dans la base</button>
    </div>

    <!-- Tableau √©lecteurs -->
    <table id="electeursTable" class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Nom</th>
          <th>Pr√©nom(s)</th>
          <th>Date de naissance</th>
          <th>Adresse</th>
          <th>Bureau de vote</th>
          <th>Email</th>
          <th>T√©l√©phone</th>
          <th>Remarque</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // üîë Configuration Supabase
    const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co"; // ‚Üê remplace si besoin
    const SUPABASE_KEY = "TON_ANON_KEY"; // ‚ö†Ô∏è mets ici ton anon public key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Elements DOM
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailSpan = document.getElementById("userEmail");
    const uploadBtn = document.getElementById("uploadBtn");
    const csvFileInput = document.getElementById("csvFile");
    const tbody = document.querySelector("#electeursTable tbody");

    // üîπ Charger donn√©es depuis Supabase
    async function loadData() {
      const { data, error } = await supabase.from("electeurs").select("*");
      if (error) {
        console.error("Erreur lecture :", error);
        return;
      }
      renderTable(data);
    }

    // üîπ Rendu du tableau
    function renderTable(data) {
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.nom}</td>
          <td>${row.prenoms}</td>
          <td>${row.naissance || ""}</td>
          <td>${row.adresse || ""}</td>
          <td>${row.bureau || ""}</td>
          <td contenteditable="true">${row.email || ""}</td>
          <td contenteditable="true">${row.telephone || ""}</td>
          <td contenteditable="true">${row.remarque || ""}</td>
          <td>${row.statut || "-"}</td>
          <td>
            <button class="btn btn-success btn-sm">Favorable</button>
            <button class="btn btn-danger btn-sm">D√©favorable</button>
            <button class="btn btn-warning btn-sm">Ind√©cis</button>
            <button class="btn btn-secondary btn-sm">Absent</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // üîπ Importer CSV et stocker en base
    uploadBtn.addEventListener("click", () => {
      const file = csvFileInput.files[0];
      if (!file) {
        alert("Choisis un fichier CSV !");
        return;
      }
      Papa.parse(file, {
        header: true,
        complete: async (results) => {
          const formatted = results.data.map(row => ({
            nom: (row["nom de naissance"] || "") + " " + (row["nom d‚Äôusage"] || ""),
            prenoms: row["pr√©noms"] || "",
            naissance: row["date de naissance"] || "",
            adresse: (row["num√©ro de voie"] || "") + " " + (row["libell√© de voie"] || ""),
            bureau: row["libell√© du bureau de vote"] || "",
            email: "",
            telephone: "",
            remarque: "",
            statut: "-"
          }));
          const { error } = await supabase.from("electeurs").insert(formatted);
          if (error) {
            console.error("Erreur insertion :", error);
            alert("Erreur importation");
          } else {
            alert("Import r√©ussi !");
            loadData();
          }
        }
      });
    });

    // üîπ Gestion session
    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "index.html"; // retour login si pas connect√©
      } else {
        userEmailSpan.textContent = "Connect√© : " + session.user.email;
        loadData();
      }
    }

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    checkSession();
  </script>
</body>
</html>

