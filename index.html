<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    h1 { font-size: 22px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background:#eee; }
    .menu { margin:15px 0; }
    button { margin:5px; padding:8px 12px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>üìã Porte-√†-Porte</h1>
  <div id="auth"></div>
  <div id="app" style="display:none;">
    <p>Connect√© : <span id="userEmail"></span> <button onclick="logout()">Se d√©connecter</button></p>

    <div class="menu">
      <input type="file" id="csvFile" accept=".csv">
      <button onclick="importCSV()">Importer un CSV</button>
      <button onclick="exportCSV()">Exporter le CSV (complet)</button>
      <button onclick="exportFilter('Favorable')">Exporter Favorables</button>
      <button onclick="exportFilter('Ind√©cis')">Exporter Favorables + Ind√©cis</button>
      <br>
      <label>Bureau : <input id="filterBureau" oninput="loadElecteurs()"></label>
      <label>Recherche : <input id="filterSearch" oninput="loadElecteurs()"></label>
    </div>

    <table id="electeursTable">
      <thead>
        <tr>
          <th>Nom</th><th>Pr√©nom</th><th>Bureau</th><th>Adresse</th>
          <th>Email</th><th>T√©l√©phone</th><th>Remarque</th><th>Statut</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co"; // ton URL
    const SUPABASE_ANON_KEY = "TON_ANON_KEY"; // remplace par ta cl√© publique
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    // V√©rifier session
    supabase.auth.getSession().then(({ data }) => {
      if (data.session) {
        currentUser = data.session.user;
        showApp();
      } else showLogin();
    });

    function showLogin() {
      document.getElementById("auth").innerHTML = `
        <h2>Connexion</h2>
        <input id="email" placeholder="Email"><br>
        <input id="password" type="password" placeholder="Mot de passe"><br>
        <button onclick="login()">Se connecter</button>
        <button onclick="signup()">Cr√©er un compte</button>
      `;
    }

    function showApp() {
      document.getElementById("auth").style.display="none";
      document.getElementById("app").style.display="block";
      document.getElementById("userEmail").innerText = currentUser.email;
      loadElecteurs();
    }

    async function login() {
      const email=document.getElementById("email").value;
      const password=document.getElementById("password").value;
      const { error, data } = await supabase.auth.signInWithPassword({ email, password });
      if(error) alert(error.message); else location.reload();
    }

    async function signup() {
      const email=document.getElementById("email").value;
      const password=document.getElementById("password").value;
      const { error } = await supabase.auth.signUp({ email, password });
      if(error) alert(error.message); else alert("V√©rifie ton email pour confirmer !");
    }

    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    // Import CSV vers Supabase
    function importCSV() {
      const file=document.getElementById("csvFile").files[0];
      if(!file) return alert("Choisis un fichier CSV");
      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          const rows=results.data.filter(r=>r.Nom && r.Pr√©nom);
          for(let row of rows){
            await supabase.from("electeurs").insert({
              nom: row.Nom,
              prenom: row.Pr√©nom,
              bureau: row.Bureau,
              adresse: row.Adresse,
              email: row.Email || "",
              telephone: row.T√©l√©phone || "",
              remarque: row.Remarque || "",
              statut: row.Statut || "-"
            });
          }
          loadElecteurs();
        }
      });
    }

    // Charger donn√©es
    async function loadElecteurs() {
      let query = supabase.from("electeurs").select("*");
      const bureau=document.getElementById("filterBureau").value;
      const search=document.getElementById("filterSearch").value;
      if(bureau) query=query.ilike("bureau", `%${bureau}%`);
      if(search) query=query.or(`nom.ilike.%${search}%,prenom.ilike.%${search}%,adresse.ilike.%${search}%`);
      const { data, error } = await query;
      if(error) { console.error(error); return; }
      const tbody=document.querySelector("#electeursTable tbody");
      tbody.innerHTML="";
      data.forEach(e=>{
        tbody.innerHTML+=`
          <tr>
            <td>${e.nom||""}</td>
            <td>${e.prenom||""}</td>
            <td>${e.bureau||""}</td>
            <td>${e.adresse||""}</td>
            <td>${e.email||""}</td>
            <td>${e.telephone||""}</td>
            <td>${e.remarque||""}</td>
            <td>${e.statut||"-"}</td>
          </tr>
        `;
      });
    }

    // Export CSV
    async function exportCSV() {
      const { data } = await supabase.from("electeurs").select("*");
      const csv = Papa.unparse(data);
      downloadCSV(csv, "electeurs.csv");
    }

    async function exportFilter(type) {
      const { data } = await supabase.from("electeurs").select("*").in("statut", type==="Ind√©cis" ? ["Favorable","Ind√©cis"] : ["Favorable"]);
      const csv = Papa.unparse(data);
      downloadCSV(csv, `electeurs_${type}.csv`);
    }

    function downloadCSV(csv, filename) {
      const blob=new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      link.click();
    }
  </script>
</body>
</html>

