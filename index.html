<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-Ã -Porte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ðŸ“‹ Porte-Ã -Porte</h1>
    <div>
      <span id="userEmail" class="mr-4"></span>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Se dÃ©connecter</button>
    </div>
  </div>

  <div class="p-6">
    <h2 class="text-lg font-semibold mb-2">Importer un fichier CSV :</h2>
    <input type="file" id="csvFile" class="mb-4">
    <button onclick="importCSV()" class="bg-blue-500 text-white px-4 py-2 rounded">Importer un CSV</button>

    <table class="table-auto w-full mt-6 border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-2">Nom</th>
          <th class="border px-2">PrÃ©nom</th>
          <th class="border px-2">Bureau</th>
          <th class="border px-2">Adresse</th>
          <th class="border px-2">Email</th>
          <th class="border px-2">TÃ©lÃ©phone</th>
          <th class="border px-2">Remarque</th>
          <th class="border px-2">Statut</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
  // âš¡ Config Supabase
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // âœ… VÃ©rifier session
  async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
      document.getElementById("userEmail").innerText = "ConnectÃ© : " + session.user.email;
      loadElecteurs();
    } else {
      setTimeout(async () => {
        const { data: { session: retrySession } } = await supabaseClient.auth.getSession();
        if (!retrySession) {
          window.location.href = "login.html";
        }
      }, 1500);
    }
  }

  // DÃ©connexion
  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  // Charger les Ã©lecteurs depuis Supabase
  async function loadElecteurs() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) {
      console.error("Erreur chargement :", error);
      return;
    }
    renderTable(data);
  }

  // Rendu du tableau
  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(row => {
      tbody.innerHTML += `
        <tr>
          <td class="border px-2">${row.nom || ""}</td>
          <td class="border px-2">${row.prenom || ""}</td>
          <td class="border px-2">${row.bureau || ""}</td>
          <td class="border px-2">${row.adresse || ""}</td>
          <td class="border px-2">${row.email || ""}</td>
          <td class="border px-2">${row.telephone || ""}</td>
          <td class="border px-2">${row.remarque || ""}</td>
          <td class="border px-2">${row.statut || ""}</td>
        </tr>
      `;
    });
  }

  // Importer CSV â†’ Supabase
  function importCSV() {
    const fileInput = document.getElementById("csvFile").files[0];
    if (!fileInput) {
      alert("Choisissez un fichier CSV");
      return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim().toLowerCase());

      const dataToInsert = rows.slice(1).map(r => {
        let obj = {};
        headers.forEach((h, i) => {
          obj[h] = r[i] ? r[i].trim() : null;
        });
        return obj;
      });

      const { error } = await supabaseClient.from("electeurs").insert(dataToInsert);
      if (error) {
        alert("Erreur import : " + error.message);
      } else {
        alert("âœ… Import rÃ©ussi !");
        loadElecteurs();
      }
    };
    reader.readAsText(fileInput);
  }

  checkSession();
</script>

</body>
</html>
