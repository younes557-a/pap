<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Porte-Ã -Porte</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h1>ğŸ“‹ Porte-Ã -Porte</h1>

  <!-- Auth -->
  <div id="auth-container">
    <h2>Connexion bÃ©nÃ©vole</h2>
    <input type="email" id="loginEmail" placeholder="Votre email">
    <input type="password" id="loginPassword" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>

    <h3>CrÃ©er un compte</h3>
    <input type="email" id="signupEmail" placeholder="Votre email">
    <input type="password" id="signupPassword" placeholder="Mot de passe">
    <button onclick="signup()">CrÃ©er le compte</button>

    <h3>Mot de passe oubliÃ©</h3>
    <input type="email" id="resetEmail" placeholder="Votre email">
    <button onclick="resetPassword()">RÃ©initialiser</button>
  </div>

  <!-- Recovery form -->
  <div id="recovery-container" style="display:none;">
    <h2>RÃ©initialiser votre mot de passe</h2>
    <input type="password" id="newPassword" placeholder="Nouveau mot de passe">
    <input type="password" id="confirmPassword" placeholder="Confirmez le mot de passe">
    <button onclick="confirmRecovery()">Confirmer</button>
    <button onclick="backToLogin()">Retour Ã  la connexion</button>
  </div>

  <!-- App -->
  <div id="app-container" style="display:none;">
    <h2 id="user-info"></h2>
    <button onclick="logout()">Se dÃ©connecter</button>
    <p>ğŸ‘‰ Ici tu mettras ton application (tableau Ã©lecteurs, etc.)</p>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://trnquwaidbxjzfrisdnu.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM"
    );

    // --- Connexion
    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert("Erreur connexion: " + error.message);
    }

    // --- CrÃ©ation compte
    async function signup() {
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert("Erreur inscription: " + error.message);
      else alert("VÃ©rifiez votre email pour confirmer le compte !");
    }

    // --- Demande reset
    async function resetPassword() {
      const email = document.getElementById("resetEmail").value;
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: "https://younes557-a.github.io/pap/"
      });
      if (error) alert("Erreur: " + error.message);
      else alert("Email de rÃ©initialisation envoyÃ© !");
    }

    // --- DÃ©tection recovery
    async function handleRecovery() {
      const hash = window.location.hash;
      if (hash.includes("type=recovery")) {
        document.getElementById("auth-container").style.display = "none";
        document.getElementById("app-container").style.display = "none";
        document.getElementById("recovery-container").style.display = "block";
      }
    }

    // --- Confirmer nouveau mot de passe
    async function confirmRecovery() {
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;
      if (newPass !== confirmPass) {
        alert("Les mots de passe ne correspondent pas.");
        return;
      }
      const { error } = await supabase.auth.updateUser({ password: newPass });
      if (error) alert("Erreur: " + error.message);
      else {
        alert("Mot de passe mis Ã  jour avec succÃ¨s !");
        window.location.hash = "";
        checkUser();
      }
    }

    function backToLogin() {
      document.getElementById("recovery-container").style.display = "none";
      document.getElementById("auth-container").style.display = "block";
    }

    // --- DÃ©connexion
    async function logout() {
      await supabase.auth.signOut();
      checkUser();
    }

    // --- VÃ©rification utilisateur
    async function checkUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        document.getElementById("auth-container").style.display = "none";
        document.getElementById("recovery-container").style.display = "none";
        document.getElementById("app-container").style.display = "block";
        document.getElementById("user-info").innerText = "ConnectÃ© : " + user.email;
      } else {
        document.getElementById("auth-container").style.display = "block";
        document.getElementById("recovery-container").style.display = "none";
        document.getElementById("app-container").style.display = "none";
      }
    }

    supabase.auth.onAuthStateChange(() => checkUser());
    checkUser();
    handleRecovery();
  </script>
</body>
</html>
