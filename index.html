<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

  <!-- Barre de navigation -->
  <div class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">üìã Porte-√†-Porte</h1>
    <div id="user-info" class="text-gray-700"></div>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Se d√©connecter</button>
  </div>

  <!-- Barre d‚Äôoutils -->
  <div class="p-4 bg-white shadow mt-4 mx-4 rounded">
    <div class="flex flex-wrap gap-2 mb-4">
      <input type="file" id="csvFile" accept=".csv" class="border p-2 rounded">
      <button onclick="importCSV()" class="bg-blue-500 text-white px-3 py-2 rounded">Importer un CSV</button>
      <button onclick="exportCSV()" class="bg-gray-700 text-white px-3 py-2 rounded">Exporter le CSV</button>
      <button onclick="exportFavorable()" class="bg-green-500 text-white px-3 py-2 rounded">Exporter Favorables</button>
      <button onclick="exportFavorablesIndecis()" class="bg-orange-500 text-white px-3 py-2 rounded">Exporter Favorables + Ind√©cis</button>
    </div>

    <!-- Filtres -->
    <div class="flex flex-wrap gap-4">
      <input type="text" id="search" placeholder="Nom, rue, adresse..." class="border p-2 rounded flex-1">
      <select id="sortBy" class="border p-2 rounded">
        <option value="bureau">Bureau</option>
        <option value="nom">Nom</option>
        <option value="prenom">Pr√©nom</option>
      </select>
      <select id="sortOrder" class="border p-2 rounded">
        <option value="asc">Asc</option>
        <option value="desc">Desc</option>
      </select>
      <button onclick="applyFilters()" class="bg-blue-600 text-white px-3 py-2 rounded">Appliquer</button>
    </div>
  </div>

  <!-- Tableau √©lecteurs -->
  <div class="p-4">
    <table class="w-full border-collapse bg-white shadow rounded" id="electeursTable">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Nom</th>
          <th class="border p-2">Pr√©nom</th>
          <th class="border p-2">Bureau</th>
          <th class="border p-2">Adresse</th>
          <th class="border p-2">Email</th>
          <th class="border p-2">T√©l√©phone</th>
          <th class="border p-2">Remarque</th>
          <th class="border p-2">Statut</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="electeursBody"></tbody>
    </table>
  </div>

<script>
  // ‚ö° Supabase config
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let electeurs = [];

  // Charger utilisateur connect√©
  async function loadUser() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (user) {
      document.getElementById("user-info").innerText = "Connect√© : " + user.email;
      loadElecteurs();
    } else {
      window.location.href = "login.html";
    }
  }

  // D√©connexion
  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  // Charger √©lecteurs depuis Supabase
  async function loadElecteurs() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) {
      console.error(error);
    } else {
      electeurs = data;
      renderTable();
    }
  }

  // Afficher le tableau
  function renderTable() {
    const tbody = document.getElementById("electeursBody");
    tbody.innerHTML = "";
    electeurs.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border p-2">${row.nom || ""}</td>
        <td class="border p-2">${row.prenom || ""}</td>
        <td class="border p-2">${row.bureau || ""}</td>
        <td class="border p-2">${row.adresse || ""}</td>
        <td class="border p-2">${row.email || ""}</td>
        <td class="border p-2">${row.telephone || ""}</td>
        <td class="border p-2">${row.remarque || ""}</td>
        <td class="border p-2">${row.statut || "-"}</td>
        <td class="border p-2">
          <button onclick="updateStatut('${row.id}','Favorable')" class="bg-green-500 text-white px-2 py-1 rounded">Favorable</button>
          <button onclick="updateStatut('${row.id}','D√©favorable')" class="bg-red-500 text-white px-2 py-1 rounded">D√©favorable</button>
          <button onclick="updateStatut('${row.id}','Ind√©cis')" class="bg-yellow-500 text-white px-2 py-1 rounded">Ind√©cis</button>
          <button onclick="updateStatut('${row.id}','Absent')" class="bg-gray-500 text-white px-2 py-1 rounded">Absent</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Mettre √† jour le statut
  async function updateStatut(id, statut) {
    await supabaseClient.from("electeurs").update({ statut }).eq("id", id);
    loadElecteurs();
  }

  // Import CSV ‚Üí Supabase
  async function importCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Choisissez un fichier CSV !");
    const text = await file.text();
    const rows = text.split("\n").map(r => r.split(","));
    const headers = rows.shift();

    const data = rows.map(r => ({
      nom: r[0] || "",
      prenom: r[1] || "",
      bureau: r[2] || "",
      adresse: r[3] || "",
      email: r[4] || "",
      telephone: r[5] || "",
      remarque: r[6] || "",
      statut: r[7] || null,
    }));

    const { error } = await supabaseClient.from("electeurs").insert(data);
    if (error) {
      alert("Erreur import : " + error.message);
    } else {
      alert("Import r√©ussi !");
      loadElecteurs();
    }
  }

  // Export CSV complet
  function exportCSV() {
    downloadCSV(electeurs, "electeurs_complet.csv");
  }

  function exportFavorable() {
    const fav = electeurs.filter(e => e.statut === "Favorable");
    downloadCSV(fav, "electeurs_favorables.csv");
  }

  function exportFavorablesIndecis() {
    const subset = electeurs.filter(e => e.statut === "Favorable" || e.statut === "Ind√©cis");
    downloadCSV(subset, "electeurs_fav_indecis.csv");
  }

  // G√©n√©rateur CSV
  function downloadCSV(data, filename) {
    if (!data.length) return;
    const headers = Object.keys(data[0]).join(",");
    const rows = data.map(obj => Object.values(obj).join(",")).join("\n");
    const blob = new Blob([headers + "\n" + rows], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  // Appliquer filtres/recherche
  function applyFilters() {
    let filtered = [...electeurs];
    const search = document.getElementById("search").value.toLowerCase();
    if (search) {
      filtered = filtered.filter(e =>
        (e.nom || "").toLowerCase().includes(search) ||
        (e.prenom || "").toLowerCase().includes(search) ||
        (e.adresse || "").toLowerCase().includes(search)
      );
    }
    const sortBy = document.getElementById("sortBy").value;
    const sortOrder = document.getElementById("sortOrder").value;
    filtered.sort((a, b) => {
      if (a[sortBy] < b[sortBy]) return sortOrder === "asc" ? -1 : 1;
      if (a[sortBy] > b[sortBy]) return sortOrder === "asc" ? 1 : -1;
      return 0;
    });
    electeurs = filtered;
    renderTable();
  }

  // Lancer
  loadUser();
</script>
</body>
</html>
