<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-Ã -Porte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Auth container -->
  <div id="auth-container" class="max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow-md">
    <h1 class="text-2xl font-bold mb-4">ðŸ“‹ Porte-Ã -Porte</h1>

    <h2 class="text-lg font-semibold mb-2">Connexion bÃ©nÃ©vole</h2>
    <input id="loginEmail" type="email" placeholder="Votre email" class="border p-2 w-full mb-2">
    <input id="loginPassword" type="password" placeholder="Mot de passe" class="border p-2 w-full mb-2">
    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Se connecter</button>

    <h2 class="text-lg font-semibold mt-4 mb-2">CrÃ©er un compte</h2>
    <input id="signupEmail" type="email" placeholder="Votre email" class="border p-2 w-full mb-2">
    <input id="signupPassword" type="password" placeholder="Mot de passe" class="border p-2 w-full mb-2">
    <button onclick="signup()" class="bg-green-500 text-white px-4 py-2 rounded w-full">CrÃ©er le compte</button>

    <h2 class="text-lg font-semibold mt-4 mb-2">Mot de passe oubliÃ©</h2>
    <input id="resetEmail" type="email" placeholder="Votre email" class="border p-2 w-full mb-2">
    <button onclick="resetPassword()" class="bg-yellow-500 text-white px-4 py-2 rounded w-full">RÃ©initialiser</button>
  </div>

  <!-- Reset container -->
  <div id="recovery-container" class="hidden max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow-md">
    <h2 class="text-lg font-semibold mb-2">ðŸ”‘ RÃ©initialiser le mot de passe</h2>
    <input id="newPassword" type="password" placeholder="Nouveau mot de passe" class="border p-2 w-full mb-2">
    <input id="confirmPassword" type="password" placeholder="Confirmer le mot de passe" class="border p-2 w-full mb-2">
    <button onclick="confirmRecovery()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Valider</button>
    <button onclick="logout()" class="bg-gray-400 text-white px-4 py-2 rounded w-full mt-2">Retour</button>
  </div>

  <!-- App container -->
  <div id="app-container" class="hidden p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">ðŸ“‹ Porte-Ã -Porte</h1>
      <div>
        <span id="user-info" class="font-semibold mr-4"></span>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Se dÃ©connecter</button>
      </div>
    </div>

    <!-- Import CSV -->
    <input type="file" id="csvFile" accept=".csv" class="mb-4">

    <!-- Tableau Ã©lecteurs -->
    <div class="overflow-x-auto">
      <table id="electeursTable" class="min-w-full bg-white border border-gray-300 text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-2 py-1 border">Nom</th>
            <th class="px-2 py-1 border">PrÃ©nom</th>
            <th class="px-2 py-1 border">Bureau</th>
            <th class="px-2 py-1 border">Adresse</th>
            <th class="px-2 py-1 border">Email</th>
            <th class="px-2 py-1 border">TÃ©lÃ©phone</th>
            <th class="px-2 py-1 border">Remarque</th>
            <th class="px-2 py-1 border">Statut</th>
            <th class="px-2 py-1 border">Actions</th>
          </tr>
        </thead>
        <tbody id="electeursBody"></tbody>
      </table>
    </div>
  </div>

<script>
  const supabase = window.supabase.createClient(
    "https://trnquwaidbxjzfrisdnu.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM"
  );

  // --- AUTH ---
  async function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert("Erreur : " + error.message);
  }

  async function signup() {
    const email = document.getElementById("signupEmail").value;
    const password = document.getElementById("signupPassword").value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) alert("Erreur : " + error.message);
    else alert("VÃ©rifiez vos emails pour confirmer votre compte.");
  }

  async function resetPassword() {
    const email = document.getElementById("resetEmail").value;
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: "https://younes557-a.github.io/pap/"
    });
    if (error) alert("Erreur : " + error.message);
    else alert("Email envoyÃ© !");
  }

  async function confirmRecovery() {
    const newPass = document.getElementById("newPassword").value;
    const confirmPass = document.getElementById("confirmPassword").value;
    if (newPass !== confirmPass) {
      alert("Les mots de passe ne correspondent pas.");
      return;
    }
    const { error } = await supabase.auth.updateUser({ password: newPass });
    if (error) alert("Erreur : " + error.message);
    else {
      alert("Mot de passe changÃ© !");
      window.location.hash = "";
      checkUser();
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    checkUser();
  }

  async function checkUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      document.getElementById("auth-container").style.display = "none";
      document.getElementById("recovery-container").style.display = "none";
      document.getElementById("app-container").style.display = "block";
      document.getElementById("user-info").innerText = "ConnectÃ© : " + user.email;
    } else {
      document.getElementById("auth-container").style.display = "block";
      document.getElementById("app-container").style.display = "none";
      document.getElementById("recovery-container").style.display = "none";
    }
  }

  supabase.auth.onAuthStateChange((event, session) => {
    if (event === "PASSWORD_RECOVERY") {
      document.getElementById("auth-container").style.display = "none";
      document.getElementById("app-container").style.display = "none";
      document.getElementById("recovery-container").style.display = "block";
    }
    checkUser();
  });
  checkUser();

  // --- CSV IMPORT ---
  document.getElementById("csvFile").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      const tbody = document.getElementById("electeursBody");
      tbody.innerHTML = "";
      rows.slice(1).forEach((row, i) => {
        if (row.length < 4) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2">${row[0]}</td>
          <td class="border px-2">${row[1]}</td>
          <td class="border px-2">${row[2]}</td>
          <td class="border px-2">${row[3]}</td>
          <td class="border px-2"><input type="email" class="w-full border"></td>
          <td class="border px-2"><input type="tel" class="w-full border"></td>
          <td class="border px-2"><input type="text" class="w-full border"></td>
          <td class="border px-2" id="status-${i}">-</td>
          <td class="border px-2">
            <button onclick="setStatus(${i}, 'Favorable')" class="bg-green-500 text-white px-2 py-1 rounded">Favorable</button>
            <button onclick="setStatus(${i}, 'DÃ©favorable')" class="bg-red-500 text-white px-2 py-1 rounded">DÃ©favorable</button>
            <button onclick="setStatus(${i}, 'IndÃ©cis')" class="bg-yellow-500 text-white px-2 py-1 rounded">IndÃ©cis</button>
            <button onclick="setStatus(${i}, 'Absent')" class="bg-gray-500 text-white px-2 py-1 rounded">Absent</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    };
    reader.readAsText(file, "UTF-8");
  });

  function setStatus(id, status) {
    const td = document.getElementById("status-" + id);
    td.textContent = status;
    const tr = td.parentElement;
    tr.classList.remove("bg-green-100", "bg-red-100");
    if (status === "Favorable") tr.classList.add("bg-green-100");
    if (status === "DÃ©favorable") tr.classList.add("bg-red-100");
  }
</script>
</body>
</html>
