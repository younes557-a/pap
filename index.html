<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

  <div class="p-4 bg-white shadow-md flex justify-between items-center">
    <h1 class="text-xl font-bold">üìã Porte-√†-Porte</h1>
    <div>
      <span id="userEmail" class="mr-4"></span>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Se d√©connecter</button>
    </div>
  </div>

  <div class="p-4">
    <div class="flex gap-2 mb-4">
      <input type="file" id="csvFile" class="border p-2">
      <button onclick="importCSV()" class="bg-blue-500 text-white px-4 py-2 rounded">Importer un CSV</button>
      <button onclick="exportCSV()" class="bg-gray-600 text-white px-4 py-2 rounded">Exporter le CSV</button>
    </div>

    <table class="min-w-full bg-white border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border px-2 py-1">Nom</th>
          <th class="border px-2 py-1">Pr√©nom</th>
          <th class="border px-2 py-1">Bureau</th>
          <th class="border px-2 py-1">Adresse</th>
          <th class="border px-2 py-1">Email</th>
          <th class="border px-2 py-1">T√©l√©phone</th>
          <th class="border px-2 py-1">Remarque</th>
          <th class="border px-2 py-1">Statut</th>
          <th class="border px-2 py-1">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
  // ‚ö° Config Supabase
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ‚úÖ V√©rifier utilisateur connect√©
  supabaseClient.auth.getUser().then(({ data, error }) => {
    if (error || !data.user) {
      window.location.href = "login.html";
    } else {
      document.getElementById("userEmail").innerText = "Connect√© : " + data.user.email;
      loadData();
    }
  });

  // üö™ D√©connexion
  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  // üì• Charger les donn√©es
  async function loadData() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) {
      alert("Erreur chargement : " + error.message);
      return;
    }
    renderTable(data);
  }

  // üì§ Mettre √† jour statut
  async function updateStatut(id, statut) {
    const { error } = await supabaseClient.from("electeurs").update({ statut }).eq("id", id);
    if (error) {
      alert("Erreur maj : " + error.message);
    } else {
      loadData();
    }
  }

  // üñºÔ∏è Afficher le tableau
  function renderTable(rows) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2 py-1">${r.nom || ""}</td>
        <td class="border px-2 py-1">${r.prenom || ""}</td>
        <td class="border px-2 py-1">${r.bureau || ""}</td>
        <td class="border px-2 py-1">${r.adresse || ""}</td>
        <td class="border px-2 py-1">${r.email || ""}</td>
        <td class="border px-2 py-1">${r.telephone || ""}</td>
        <td class="border px-2 py-1">${r.remarque || ""}</td>
        <td class="border px-2 py-1">${r.statut || "-"}</td>
        <td class="border px-2 py-1">
          <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="updateStatut(${r.id}, 'Favorable')">Favorable</button>
          <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="updateStatut(${r.id}, 'D√©favorable')">D√©favorable</button>
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="updateStatut(${r.id}, 'Ind√©cis')">Ind√©cis</button>
          <button class="bg-gray-500 text-white px-2 py-1 rounded" onclick="updateStatut(${r.id}, 'Absent')">Absent</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // üì• Import CSV (√† am√©liorer selon ton format exact)
  async function importCSV() {
    const fileInput = document.getElementById("csvFile");
    if (!fileInput.files.length) {
      alert("Choisis un fichier CSV !");
      return;
    }
    alert("‚ö° Import CSV √† connecter au backend Supabase.");
  }

  // üì§ Export CSV
  async function exportCSV() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) {
      alert("Erreur export : " + error.message);
      return;
    }
    let csv = "Nom,Pr√©nom,Bureau,Adresse,Email,T√©l√©phone,Remarque,Statut\n";
    data.forEach(r => {
      csv += `${r.nom||""},${r.prenom||""},${r.bureau||""},${r.adresse||""},${r.email||""},${r.telephone||""},${r.remarque||""},${r.statut||""}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "electeurs.csv";
    link.click();
  }
</script>

</body>
</html>
