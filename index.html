<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
  <div class="p-4 flex justify-between items-center bg-white shadow">
    <h1 class="text-2xl font-bold">üìã Porte-√†-Porte</h1>
    <div id="user-info" class="font-semibold"></div>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Se d√©connecter</button>
  </div>

  <div class="p-4">
    <!-- Boutons Import/Export -->
    <div class="mb-4 flex space-x-2">
      <input type="file" id="csvFile" class="border p-2">
      <button onclick="importCSV()" class="bg-blue-500 text-white px-4 py-2 rounded">Importer un CSV</button>
      <button onclick="exportCSV()" class="bg-gray-600 text-white px-4 py-2 rounded">Exporter le CSV</button>
      <button onclick="exportByStatut('Favorable')" class="bg-green-500 text-white px-4 py-2 rounded">Exporter Favorables</button>
      <button onclick="exportByStatut('Favorable,Ind√©cis')" class="bg-orange-500 text-white px-4 py-2 rounded">Exporter Favorables + Ind√©cis</button>
    </div>

    <!-- Tableau √©lecteurs -->
    <table class="table-auto w-full bg-white rounded shadow">
      <thead>
        <tr class="bg-gray-200">
          <th class="px-2 py-1">Nom</th>
          <th class="px-2 py-1">Pr√©nom</th>
          <th class="px-2 py-1">Bureau</th>
          <th class="px-2 py-1">Adresse</th>
          <th class="px-2 py-1">Email</th>
          <th class="px-2 py-1">T√©l√©phone</th>
          <th class="px-2 py-1">Remarque</th>
          <th class="px-2 py-1">Statut</th>
          <th class="px-2 py-1">Actions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

<script>
  // ‚ö° Config Supabase
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // V√©rifier si utilisateur connect√©
  supabaseClient.auth.getUser().then(({ data }) => {
    if (data.user) {
      document.getElementById("user-info").innerText = "Connect√© : " + data.user.email;
      loadData();
    } else {
      window.location.href = "login.html";
    }
  });

  // D√©connexion
  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  // Charger les donn√©es
  async function loadData() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) {
      alert("Erreur chargement : " + error.message);
      return;
    }
    renderTable(data);
  }

  // Affichage du tableau
  function renderTable(rows) {
    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";
    rows.forEach(row => {
      tbody.innerHTML += `
        <tr class="border-b">
          <td class="px-2 py-1">${row.nom || ""}</td>
          <td class="px-2 py-1">${row.prenom || ""}</td>
          <td class="px-2 py-1">${row.bureau || ""}</td>
          <td class="px-2 py-1">${row.adresse || ""}</td>
          <td class="px-2 py-1">
            <input type="text" value="${row.email || ''}" 
              onchange="updateField(${row.id}, 'email', this.value)" class="border p-1 w-full"/>
          </td>
          <td class="px-2 py-1">
            <input type="text" value="${row.telephone || ''}" 
              onchange="updateField(${row.id}, 'telephone', this.value)" class="border p-1 w-full"/>
          </td>
          <td class="px-2 py-1">
            <input type="text" value="${row.remarque || ''}" 
              onchange="updateField(${row.id}, 'remarque', this.value)" class="border p-1 w-full"/>
          </td>
          <td class="px-2 py-1">${row.statut || "-"}</td>
          <td class="px-2 py-1 space-x-1">
            <button onclick="updateStatut(${row.id}, 'Favorable')" class="bg-green-500 text-white px-2 py-1 rounded">Favorable</button>
            <button onclick="updateStatut(${row.id}, 'D√©favorable')" class="bg-red-500 text-white px-2 py-1 rounded">D√©favorable</button>
            <button onclick="updateStatut(${row.id}, 'Ind√©cis')" class="bg-yellow-500 text-white px-2 py-1 rounded">Ind√©cis</button>
            <button onclick="updateStatut(${row.id}, 'Absent')" class="bg-gray-500 text-white px-2 py-1 rounded">Absent</button>
          </td>
        </tr>
      `;
    });
  }

  // Mettre √† jour un champ
  async function updateField(id, column, value) {
    const { error } = await supabaseClient.from("electeurs").update({ [column]: value }).eq("id", id);
    if (error) alert("Erreur mise √† jour : " + error.message);
  }

  // Mettre √† jour le statut
  async function updateStatut(id, statut) {
    const { error } = await supabaseClient.from("electeurs").update({ statut }).eq("id", id);
    if (error) {
      alert("Erreur statut : " + error.message);
    } else {
      loadData();
    }
  }

  // Import CSV
  async function importCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Choisissez un fichier CSV");
    Papa.parse(file, {
      header: true,
      complete: async function(results) {
        const { error } = await supabaseClient.from("electeurs").insert(results.data);
        if (error) alert("Erreur import : " + error.message);
        else loadData();
      }
    });
  }

  // Export CSV
  async function exportCSV() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) return alert("Erreur export : " + error.message);
    const csv = Papa.unparse(data);
    downloadFile(csv, "export.csv");
  }

  // Export filtr√©
  async function exportByStatut(statut) {
    const { data, error } = await supabaseClient.from("electeurs").select("*").in("statut", statut.split(","));
    if (error) return alert("Erreur export : " + error.message);
    const csv = Papa.unparse(data);
    downloadFile(csv, "export_" + statut + ".csv");
  }

  // T√©l√©charger fichier
  function downloadFile(content, filename) {
    const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
</body>
</html>

