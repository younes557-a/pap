<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

  <!-- Barre du haut -->
  <nav class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">üìã Porte-√†-Porte</h1>
    <div>
      <span id="user-email" class="mr-4 text-gray-700"></span>
      <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded">Se d√©connecter</button>
    </div>
  </nav>

  <!-- Outils -->
  <div class="bg-gray-50 shadow p-4 flex flex-wrap gap-4 items-end">
    <div>
      <label class="block text-sm font-medium">Bureau de vote</label>
      <select id="filter-bureau" class="border rounded px-2 py-1" onchange="loadVoters()">
        <option value="">Tous</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium">Recherche</label>
      <input id="search" type="text" placeholder="Nom, rue..." class="border rounded px-2 py-1">
    </div>
    <button onclick="loadVoters()" class="bg-blue-500 text-white px-3 py-1 rounded">Chercher</button>
    <button onclick="resetFilters()" class="bg-gray-300 px-3 py-1 rounded">R√©initialiser</button>
    <button onclick="exportCSV('all')" class="bg-green-500 text-white px-3 py-1 rounded">Exporter CSV (complet)</button>
    <button onclick="exportCSV('favorables')" class="bg-green-600 text-white px-3 py-1 rounded">Exporter Favorables</button>
    <button onclick="exportCSV('favorables-indecis')" class="bg-orange-500 text-white px-3 py-1 rounded">Exporter Favorables + Ind√©cis</button>
  </div>

  <!-- Tableau -->
  <div class="p-4 overflow-x-auto">
    <table class="w-full border border-gray-300 bg-white">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-2 py-1">Nom</th>
          <th class="border px-2 py-1">Pr√©nom</th>
          <th class="border px-2 py-1">Bureau</th>
          <th class="border px-2 py-1">Adresse</th>
          <th class="border px-2 py-1">Email</th>
          <th class="border px-2 py-1">T√©l√©phone</th>
          <th class="border px-2 py-1">Remarque</th>
          <th class="border px-2 py-1">Statut</th>
          <th class="border px-2 py-1">Actions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

<script>
  // ‚ö° Config Supabase
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ‚ö° V√©rifier session
  async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      window.location.href = "login.html";
    } else {
      document.getElementById("user-email").innerText = "Connect√© : " + session.user.email;
    }
  }

  checkSession();

  // ‚ö° Charger √©lecteurs
  async function loadVoters() {
    let query = supabaseClient.from("voters").select("*");

    const bureau = document.getElementById("filter-bureau").value;
    const search = document.getElementById("search").value;

    if (bureau) query = query.eq("bureau", bureau);
    if (search) query = query.ilike("nom", `%${search}%`);

    let { data, error } = await query;
    if (error) {
      alert("Erreur : " + error.message);
      return;
    }

    renderTable(data);
    fillBureauOptions(data);
  }

  // ‚ö° Remplir tableau
  function renderTable(rows) {
    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";
    rows.forEach(r => {
      tbody.innerHTML += `
        <tr class="border">
          <td class="border px-2">${r.nom || ""}</td>
          <td class="border px-2">${r.prenom || ""}</td>
          <td class="border px-2">${r.bureau || ""}</td>
          <td class="border px-2">${r.adresse || ""}</td>
          <td class="border px-2">${r.email || ""}</td>
          <td class="border px-2">${r.telephone || ""}</td>
          <td class="border px-2">${r.remarque || ""}</td>
          <td class="border px-2">${r.statut || "-"}</td>
          <td class="border px-2 space-x-1">
            <button onclick="updateStatut('${r.id}','Favorable')" class="bg-green-500 text-white px-2">Favorable</button>
            <button onclick="updateStatut('${r.id}','D√©favorable')" class="bg-red-500 text-white px-2">D√©favorable</button>
            <button onclick="updateStatut('${r.id}','Ind√©cis')" class="bg-yellow-500 text-white px-2">Ind√©cis</button>
          </td>
        </tr>
      `;
    });
  }

  // ‚ö° Mise √† jour statut
  async function updateStatut(id, statut) {
    let { error } = await supabaseClient.from("voters").update({ statut }).eq("id", id);
    if (error) alert("Erreur MAJ : " + error.message);
    else loadVoters();
  }

  // ‚ö° Options bureau
  function fillBureauOptions(rows) {
    const select = document.getElementById("filter-bureau");
    const values = [...new Set(rows.map(r => r.bureau).filter(Boolean))];
    select.innerHTML = '<option value="">Tous</option>';
    values.forEach(b => {
      select.innerHTML += `<option value="${b}">${b}</option>`;
    });
  }

  // ‚ö° Export CSV
  async function exportCSV(type) {
    let query = supabaseClient.from("voters").select("*");
    if (type === "favorables") query = query.eq("statut", "Favorable");
    if (type === "favorables-indecis") query = query.in("statut", ["Favorable", "Ind√©cis"]);

    let { data, error } = await query;
    if (error) {
      alert("Erreur export : " + error.message);
      return;
    }

    let csv = "Nom,Pr√©nom,Bureau,Adresse,Email,T√©l√©phone,Remarque,Statut\n";
    data.forEach(r => {
      csv += `"${r.nom||""}","${r.prenom||""}","${r.bureau||""}","${r.adresse||""}","${r.email||""}","${r.telephone||""}","${r.remarque||""}","${r.statut||""}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "export.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ‚ö° Reset filtres
  function resetFilters() {
    document.getElementById("filter-bureau").value = "";
    document.getElementById("search").value = "";
    loadVoters();
  }

  // ‚ö° Logout
  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  // Charger initialement
  loadVoters();
</script>

</body>
</html>

