<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // === CONFIG SUPABASE ===
    const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // === DOM Elements ===
    const authDiv = document.getElementById("auth");
    const appDiv = document.getElementById("app");
    const votersTable = document.getElementById("votersTable");

    // === Gestion de l'√©tat utilisateur ===
    async function checkUser() {
      const { data } = await supabase.auth.getUser();
      if (data.user) {
        authDiv.style.display = "none";
        appDiv.style.display = "block";
        document.getElementById("userEmail").innerText = data.user.email;
        loadVoters();
      } else {
        authDiv.style.display = "block";
        appDiv.style.display = "none";
      }
    }

    // === Authentification ===
    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert("Erreur connexion: " + error.message);
      checkUser();
    }

    async function signup() {
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert("Erreur inscription: " + error.message);
      else alert("V√©rifiez vos mails pour confirmer l'inscription !");
    }

    async function resetPassword() {
      const email = document.getElementById("resetEmail").value;
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: "https://younes557-a.github.io/pap/"
      });
      if (error) alert("Erreur: " + error.message);
      else alert("Email de r√©initialisation envoy√© !");
    }

    async function logout() {
      await supabase.auth.signOut();
      checkUser();
    }

    // === Charger les √©lecteurs depuis Supabase ===
    async function loadVoters() {
      const { data, error } = await supabase.from("voters").select("*");
      if (error) {
        alert("Erreur chargement √©lecteurs: " + error.message);
        return;
      }
      renderVoters(data);
    }

    // === Affichage du tableau ===
    function renderVoters(voters) {
      votersTable.innerHTML = "";
      voters.forEach(v => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${v.nom || ""}</td>
          <td>${v.prenom || ""}</td>
          <td>${v.bureau || ""}</td>
          <td>${v.adresse || ""}</td>
          <td><input type="text" value="${v.email || ""}" onchange="updateField(${v.id}, 'email', this.value)"></td>
          <td><input type="text" value="${v.telephone || ""}" onchange="updateField(${v.id}, 'telephone', this.value)"></td>
          <td><input type="text" value="${v.remarque || ""}" onchange="updateField(${v.id}, 'remarque', this.value)"></td>
          <td>${v.statut || "-"}</td>
          <td>
            <button onclick="updateField(${v.id}, 'statut', 'Favorable')" style="background:#4CAF50;color:white">Favorable</button>
            <button onclick="updateField(${v.id}, 'statut', 'D√©favorable')" style="background:#f44336;color:white">D√©favorable</button>
            <button onclick="updateField(${v.id}, 'statut', 'Ind√©cis')" style="background:#ff9800;color:white">Ind√©cis</button>
            <button onclick="updateField(${v.id}, 'statut', 'Absent')" style="background:#607d8b;color:white">Absent</button>
          </td>
        `;

        votersTable.appendChild(tr);
      });
    }

    // === Mise √† jour dans Supabase ===
    window.updateField = async function (id, field, value) {
      const { error } = await supabase.from("voters").update({ [field]: value }).eq("id", id);
      if (error) alert("Erreur update: " + error.message);
      else loadVoters();
    };

    // V√©rification utilisateur au chargement
    checkUser();
  </script>
</head>
<body>
  <!-- === Auth === -->
  <div id="auth">
    <h2>Connexion b√©n√©vole</h2>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>

    <h3>Cr√©er un compte</h3>
    <input id="signupEmail" placeholder="Email">
    <input id="signupPassword" type="password" placeholder="Mot de passe">
    <button onclick="signup()">Cr√©er le compte</button>

    <h3>Mot de passe oubli√©</h3>
    <input id="resetEmail" placeholder="Email">
    <button onclick="resetPassword()">R√©initialiser</button>
  </div>

  <!-- === App === -->
  <div id="app" style="display:none">
    <h2>üìã Porte-√†-Porte</h2>
    <p>Connect√© : <span id="userEmail"></span> <button onclick="logout()">Se d√©connecter</button></p>
    <table border="1" width="100%">
      <thead>
        <tr>
          <th>Nom</th><th>Pr√©nom</th><th>Bureau</th><th>Adresse</th><th>Email</th><th>T√©l√©phone</th><th>Remarque</th><th>Statut</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="votersTable"></tbody>
    </table>
  </div>
</body>
</html>


