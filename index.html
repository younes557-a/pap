<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Header -->
  <header class="p-4 bg-white shadow flex justify-between items-center">
    <h1 class="text-xl font-bold">üó≥Ô∏è Porte-√†-Porte</h1>
    <div>
      Connect√© : <span id="userEmail">Utilisateur</span>
      <button onclick="logout()" class="ml-4 bg-red-500 text-white px-3 py-1 rounded">D√©connexion</button>
    </div>
  </header>

  <!-- Import / Export -->
  <div class="p-4 flex gap-2">
    <label class="bg-blue-500 text-white px-3 py-1 rounded cursor-pointer">
      Importer un CSV
      <input type="file" id="csvFile" accept=".csv,text/csv" class="hidden" />
    </label>
    <button onclick="exportCSV()" class="bg-gray-600 text-white px-3 py-1 rounded">Exporter tout</button>
  </div>

  <!-- Table -->
  <div class="p-4">
    <table class="table-auto w-full bg-white shadow rounded text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="px-2">Nom</th>
          <th class="px-2">Pr√©nom</th>
          <th class="px-2">Bureau</th>
          <th class="px-2">Adresse</th>
          <th class="px-2">Email</th>
          <th class="px-2">T√©l√©phone</th>
          <th class="px-2">Remarque</th>
          <th class="px-2">Statut</th>
          <th class="px-2">Actions</th>
        </tr>
      </thead>
      <tbody id="electeursTable"></tbody>
    </table>
  </div>

  <footer class="p-4 text-center text-xs text-gray-500">
    ‚úÖ Donn√©es partag√©es via Supabase
  </footer>

<script>
  // ‚ö° Config Supabase
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRybnF1d2FpZGJ4anpmcmlzZG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzMyMTIsImV4cCI6MjA3MzU0OTIxMn0.uvpkuzw0JzQPj53hNlU4d0Db-TIvnfdVzBtkvhsMZhM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // üö™ D√©connexion
  async function logout() {
    await supabaseClient.auth.signOut();
    alert("D√©connect√©");
  }

  // üì• Charger les √©lecteurs
  async function loadElecteurs() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) {
      alert("Erreur chargement : " + error.message);
    } else {
      renderTable(data);
    }
  }

  // üì§ Afficher la table
  function renderTable(rows) {
    const tbody = document.getElementById("electeursTable");
    tbody.innerHTML = "";
    rows.forEach(row => {
      tbody.innerHTML += `
        <tr class="border-b">
          <td>${row.nom || ""}</td>
          <td>${row.prenom || ""}</td>
          <td>${row.bureau || ""}</td>
          <td>${row.adresse || ""}</td>
          <td><input type="text" value="${row.email || ""}" onchange="updateField(${row.id}, 'email', this.value)" class="border rounded px-1 w-28"></td>
          <td><input type="text" value="${row.telephone || ""}" onchange="updateField(${row.id}, 'telephone', this.value)" class="border rounded px-1 w-24"></td>
          <td><input type="text" value="${row.remarque || ""}" onchange="updateField(${row.id}, 'remarque', this.value)" class="border rounded px-1 w-32"></td>
          <td>${row.statut || "-"}</td>
          <td>
            <button onclick="updateStatut(${row.id}, 'Favorable')" class="bg-green-500 text-white px-2 py-1 rounded">‚úî</button>
            <button onclick="updateStatut(${row.id}, 'D√©favorable')" class="bg-red-500 text-white px-2 py-1 rounded">‚úñ</button>
            <button onclick="updateStatut(${row.id}, 'Ind√©cis')" class="bg-yellow-500 text-white px-2 py-1 rounded">?</button>
            <button onclick="updateStatut(${row.id}, 'Absent')" class="bg-gray-500 text-white px-2 py-1 rounded">√ò</button>
          </td>
        </tr>`;
    });
  }

  // ‚úÖ Mise √† jour statut
  async function updateStatut(id, statut) {
    const { error } = await supabaseClient.from("electeurs").update({ statut }).eq("id", id);
    if (error) alert("Erreur : " + error.message);
    else loadElecteurs();
  }

  // ‚úè Mise √† jour champ
  async function updateField(id, field, value) {
    const { error } = await supabaseClient.from("electeurs").update({ [field]: value }).eq("id", id);
    if (error) console.error(error.message);
  }

  // üìÇ Import CSV ‚Üí Supabase
  document.getElementById("csvFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true,
      delimiter: ";",
      skipEmptyLines: true,
      complete: async function(results) {
        const rows = results.data.map(r => ({
          nom: r["Nom"] || "",
          prenom: r["Pr√©nom"] || "",
          bureau: r["Bureau"] || "",
          adresse: r["Adresse"] || "",
          email: r["Email"] || "",
          telephone: r["T√©l√©phone"] || "",
          remarque: r["Remarque"] || "",
          statut: "-"
        }));
        const { error } = await supabaseClient.from("electeurs").insert(rows);
        if (error) alert("Erreur import : " + error.message);
        else {
          alert("‚úÖ Import r√©ussi !");
          loadElecteurs();
        }
      }
    });
  });

  // üì§ Export CSV
  async function exportCSV() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) { alert("Erreur export"); return; }
    const csv = Papa.unparse(data);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "electeurs.csv";
    a.click();
  }

  // üöÄ D√©marrage
  loadElecteurs();
</script>

</body>
</html>
