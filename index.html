<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Porte-√†-Porte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

  <div class="flex justify-between items-center bg-white shadow p-4">
    <h1 class="text-xl font-bold">üìã Porte-√†-Porte</h1>
    <div>
      Connect√© : <span id="userEmail" class="font-semibold"></span>
      <button onclick="logout()" class="ml-4 bg-red-500 text-white px-3 py-1 rounded">Se d√©connecter</button>
    </div>
  </div>

  <div class="p-4">
    <div class="mb-4 flex items-center space-x-2">
      <input type="file" id="csvFile" class="border p-2 rounded">
      <button onclick="importCSV()" class="bg-blue-500 text-white px-3 py-1 rounded">Importer CSV</button>
      <button onclick="exportCSV()" class="bg-gray-500 text-white px-3 py-1 rounded">Exporter tout</button>
      <button onclick="exportFavorables()" class="bg-green-500 text-white px-3 py-1 rounded">Exporter Favorables</button>
      <button onclick="exportFavorablesIndecis()" class="bg-orange-500 text-white px-3 py-1 rounded">Exporter Fav+Ind√©cis</button>
    </div>

    <input type="text" id="search" placeholder="Nom, rue, adresse..." 
      class="border p-2 rounded w-full mb-4" onkeyup="filterTable()">

    <table class="min-w-full bg-white border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border px-2">Nom</th>
          <th class="border px-2">Pr√©nom</th>
          <th class="border px-2">Bureau</th>
          <th class="border px-2">Adresse</th>
          <th class="border px-2">Email</th>
          <th class="border px-2">T√©l√©phone</th>
          <th class="border px-2">Remarque</th>
          <th class="border px-2">Statut</th>
          <th class="border px-2">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
  // ‚ö° Config Supabase
  const SUPABASE_URL = "https://trnquwaidbxjzfrisdnu.supabase.co";
  const SUPABASE_KEY = "TON_ANON_KEY_ICI";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ‚úÖ V√©rification session persistante
  async function checkAuth() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      window.location.href = "login.html";
    } else {
      document.getElementById("userEmail").innerText = session.user.email;
      loadData();
    }
  }

  supabaseClient.auth.onAuthStateChange((_event, session) => {
    if (!session) {
      window.location.href = "login.html";
    }
  });

  checkAuth();

  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  // üì• Charger depuis Supabase
  async function loadData() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) return alert("Erreur chargement : " + error.message);
    renderTable(data);
  }

  // üì• Import CSV ‚Üí Supabase
  function importCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Choisis un fichier CSV");

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: async function(results) {
        const rows = results.data.map(r => ({
          nom: r.Nom || "",
          prenom: r.Pr√©nom || "",
          bureau: r["Bureau de vote"] || r.Bureau || "",
          adresse: r.Adresse || "",
          email: r.Email || "",
          telephone: r.T√©l√©phone || "",
          remarque: r.Remarque || "",
          statut: r.Statut || "-"
        }));

        const { error } = await supabaseClient.from("electeurs").insert(rows);
        if (error) {
          alert("Erreur import : " + error.message);
        } else {
          alert("‚úÖ Import termin√© !");
          loadData();
        }
      }
    });
  }

  // üì§ Export CSV
  async function exportCSV() {
    const { data, error } = await supabaseClient.from("electeurs").select("*");
    if (error) return alert("Erreur export : " + error.message);
    const csv = Papa.unparse(data);
    downloadCSV(csv, "electeurs_complet.csv");
  }

  async function exportFavorables() {
    const { data, error } = await supabaseClient.from("electeurs").select("*").eq("statut", "Favorable");
    if (error) return alert("Erreur export : " + error.message);
    downloadCSV(Papa.unparse(data), "electeurs_favorables.csv");
  }

  async function exportFavorablesIndecis() {
    const { data, error } = await supabaseClient.from("electeurs").select("*").in("statut", ["Favorable", "Ind√©cis"]);
    if (error) return alert("Erreur export : " + error.message);
    downloadCSV(Papa.unparse(data), "electeurs_fav_indecis.csv");
  }

  function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  // üìä Rendu du tableau
  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2">${row.nom}</td>
        <td class="border px-2">${row.prenom}</td>
        <td class="border px-2">${row.bureau}</td>
        <td class="border px-2">${row.adresse}</td>
        <td class="border px-2"><input value="${row.email || ""}" onchange="updateField(${row.id}, 'email', this.value)" class="border p-1 w-full"></td>
        <td class="border px-2"><input value="${row.telephone || ""}" onchange="updateField(${row.id}, 'telephone', this.value)" class="border p-1 w-full"></td>
        <td class="border px-2"><input value="${row.remarque || ""}" onchange="updateField(${row.id}, 'remarque', this.value)" class="border p-1 w-full"></td>
        <td class="border px-2">${row.statut}</td>
        <td class="border px-2">
          <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="updateField(${row.id}, 'statut', 'Favorable')">Favorable</button>
          <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="updateField(${row.id}, 'statut', 'D√©favorable')">D√©favorable</button>
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="updateField(${row.id}, 'statut', 'Ind√©cis')">Ind√©cis</button>
          <button class="bg-gray-500 text-white px-2 py-1 rounded" onclick="updateField(${row.id}, 'statut', 'Absent')">Absent</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // üîÑ Mise √† jour champ
  async function updateField(id, field, value) {
    const { error } = await supabaseClient.from("electeurs").update({ [field]: value }).eq("id", id);
    if (error) alert("Erreur mise √† jour : " + error.message);
    else loadData();
  }

  // üîé Filtre recherche
  function filterTable() {
    const search = document.getElementById("search").value.toLowerCase();
    const rows = document.querySelectorAll("#tableBody tr");
    rows.forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(search) ? "" : "none";
    });
  }
</script>
</body>
</html>


